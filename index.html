<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç”Ÿé»æ•¸ç®¡ç†ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .student-row:hover { background-color: #f8f9fa; }
    .point-input { width: 80px; text-align: center; }
    .sticky-bottom-btn { position: sticky; bottom: 20px; z-index: 1000; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-light pb-5">
<div class="container py-4" style="max-width: 700px;">
  <h2 class="text-center mb-4 fw-bold">ğŸ“ ç­ç´šé»æ•¸ç®¡ç†ç³»çµ±</h2>

  <div id="adminPanel" style="display:none;">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
        <span>æ¯é€±é»æ•¸è¼¸å…¥åˆ—è¡¨</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTools()">æ›´å¤šå·¥å…·</button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">å§“å (å­¸è™Ÿ)</th>
                <th class="text-center">ç›®å‰ç¸½åˆ†</th>
                <th class="text-end pe-4">æœ¬æ¬¡åŠ /æ¸›åˆ†</th>
              </tr>
            </thead>
            <tbody id="studentTableBody">
              </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="text-center sticky-bottom-btn">
      <button class="btn btn-primary btn-lg px-5 shadow" onclick="submitBatchUpdates()">
        ğŸš€ çµ±ä¸€é€å‡ºæœ¬æ¬¡æ‰€æœ‰ä¿®æ”¹
      </button>
    </div>

    <div id="extraTools" class="mt-4 card p-3" style="display:none;">
       <h6>æ›´å¤šåŠŸèƒ½</h6>
       <hr>
       <button class="btn btn-outline-danger mb-2" onclick="location.reload()">ç™»å‡ºç³»çµ±</button>
       </div>
  </div>
</div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbzsXLAfuBb9rCyaGvT2aosE-TnuXlagWI2e3ITeXbOfbNC8ViC7zLy4BjBe9iWXA-kT/exec';
  let currentPwd = '';

  // æ¸²æŸ“åˆ—è¡¨ï¼šç§»é™¤æŒ‰éˆ•èˆ‡ã€Œå·²ç™»è¨˜ã€å­—æ¨£
  function renderTable(students) {
    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = students.map(stu => `
      <tr class="student-row">
        <td class="ps-4"><strong>${stu.name}</strong> <small class="text-muted">${stu.id}</small></td>
        <td class="text-center fw-bold fs-5">${stu.total}</td>
        <td class="text-end pe-4">
          <input type="number" class="form-control d-inline-block point-input" 
                 id="input-${stu.id}" data-id="${stu.id}" placeholder="+/-">
        </td>
      </tr>
    `).join('');
  }

  // æ ¸å¿ƒåŠŸèƒ½ï¼šè’é›†æ‰€æœ‰è¼¸å…¥æ¡†çš„å€¼ï¼Œä¸€æ¬¡é€å‡º
  async function submitBatchUpdates() {
    const inputs = document.querySelectorAll('.point-input');
    const updates = [];
    
    inputs.forEach(input => {
      const val = parseInt(input.value);
      if (val && val !== 0) { // åªæŠ“å–æœ‰å¡«å¯«æ•¸å­—ä¸”ä¸ç‚º 0 çš„åˆ—
        updates.push({ id: input.dataset.id, val: val });
      }
    });

    if (updates.length === 0) return alert('è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€ä½å­¸ç”Ÿçš„åŠ æ¸›åˆ†æ•¸ã€‚');

    if (!confirm(`ç¢ºå®šè¦ç‚ºé€™ ${updates.length} ä½å­¸ç”Ÿæ›´æ–°é»æ•¸å—ï¼Ÿ`)) return;

    // é¡¯ç¤ºè™•ç†ä¸­ï¼ˆå¯è‡ªè¨‚ loading ç•«é¢ï¼‰
    document.querySelector('.sticky-bottom-btn button').innerText = 'è™•ç†ä¸­...';
    
    const url = `${GAS_URL}?action=batchIndividualUpdate&pwd=${currentPwd}&updates=${encodeURIComponent(JSON.stringify(updates))}`;
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      alert(data.msg);
      if (data.success) {
        // æ›´æ–°å®Œæˆå¾Œï¼Œè‡ªå‹•é‡æ–°æŠ“å–åå–®ä»¥åæ˜ æœ€æ–°ç¸½åˆ†ï¼Œä¸¦æ¸…ç©ºè¼¸å…¥æ¡†
        adminLogin(); 
      }
    } catch (e) {
      alert('é€£ç·šå¤±æ•—');
    } finally {
      document.querySelector('.sticky-bottom-btn button').innerText = 'ğŸš€ çµ±ä¸€é€å‡ºæœ¬æ¬¡æ‰€æœ‰ä¿®æ”¹';
    }
  }

  // ç™»å…¥åŠŸèƒ½èˆ‡ adminLogin() ç¶­æŒä¹‹å‰çš„é‚è¼¯ï¼Œåªéœ€ç¢ºä¿æœƒå‘¼å« renderTable(data.data)
  function toggleTools() {
    const t = document.getElementById('extraTools');
    t.style.display = t.style.display === 'none' ? 'block' : 'none';
  }
</script>
</body>
</html>
