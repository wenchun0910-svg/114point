<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­ç´šé»æ•¸ç®¡ç†ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", sans-serif; }
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .header-area { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
    .point-input { width: 80px; border-radius: 6px; border: 1px solid #ddd; text-align: center; }
    .nav-tabs .nav-link { color: #666; font-weight: bold; }
    .nav-tabs .nav-link.active { color: #4e73df; }
  </style>
</head>
<body class="py-4">

<div class="container" style="max-width: 800px;">
  <div class="header-area text-center">
    <h2 class="fw-bold">ğŸ“ ç­ç´šé»æ•¸ç®¡ç†ç³»çµ±</h2>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">ğŸ” å­¸ç”Ÿå€‹äººæŸ¥è©¢</h5>
      <div class="row g-2">
        <div class="col-5"><input type="text" id="stuId" class="form-control" placeholder="å­¸è™Ÿ"></div>
        <div class="col-5"><input type="password" id="stuPwd" class="form-control" placeholder="æŸ¥è©¢å¯†ç¢¼"></div>
        <div class="col-2"><button class="btn btn-primary w-100" onclick="studentQuery()">æŸ¥è©¢</button></div>
      </div>
      <div id="queryStatus" class="mt-2"></div>
    </div>
  </div>

  <div id="loginBox" class="card mb-4">
    <div class="card-body">
      <h5 class="fw-bold mb-3">ğŸ” ç®¡ç†å“¡ç™»å…¥</h5>
      <div class="input-group">
        <input type="password" id="adminPwd" class="form-control" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
        <button class="btn btn-dark" onclick="adminLogin()">é€²å…¥å¾Œå°</button>
      </div>
    </div>
  </div>

  <div id="adminPanel" style="display:none;">
    <ul class="nav nav-tabs mb-3" id="adminTabs">
      <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('edit')">æ¯é€±ç´€éŒ„</a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('import')">å¤§é‡åŒ¯å…¥</a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('setting')">ç³»çµ±è¨­å®š</a></li>
    </ul>

    <div id="tab-edit" class="card p-3">
      <table class="table align-middle">
        <thead><tr><th>å§“å (å­¸è™Ÿ)</th><th class="text-center">ç›®å‰ç¸½åˆ†</th><th class="text-end">åŠ /æ¸›åˆ†</th></tr></thead>
        <tbody id="stuListBody"></tbody>
      </table>
      <button class="btn btn-primary btn-lg w-100 mt-3" id="updateBtn" onclick="submitBatch()">âœ… çµ±ä¸€æ›´æ–°å…¨ç­é»æ•¸</button>
    </div>

    <div id="tab-import" class="card p-3" style="display:none;">
      <h6>ğŸ“¥ å¤§é‡åŒ¯å…¥åå–® (CSV æ ¼å¼)</h6>
      <p class="text-muted small">æ ¼å¼ï¼šå­¸è™Ÿ,å§“å,ç›®å‰ç¸½åˆ†,æŸ¥è©¢å¯†ç¢¼</p>
      <textarea id="csvData" class="form-control mb-3" rows="8" placeholder="101,ç‹å°æ˜,50,pwd123"></textarea>
      <button class="btn btn-success w-100" onclick="importData()">åŸ·è¡Œè¦†è“‹åŒ¯å…¥</button>
    </div>

    <div id="tab-setting" class="card p-3" style="display:none;">
      <h6>ğŸ”‘ ä¿®æ”¹ç®¡ç†å“¡ç™»å…¥å¯†ç¢¼</h6>
      <div class="input-group">
        <input type="text" id="newAdminPwd" class="form-control" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
        <button class="btn btn-outline-secondary" onclick="changeAdminPwd()">ç¢ºèªä¿®æ”¹</button>
      </div>
      <hr>
      <button class="btn btn-link text-danger" onclick="location.reload()">ç™»å‡ºç³»çµ±</button>
    </div>
  </div>
</div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwqL77hSIy6xTWrcargQbfhdQO1k-EHdPmlOB1AoxNqkPkAcpFt3K7R0nP0sNVC2K8q/exec'; // å‹™å¿…æ›¿æ›
  let currentAdminPwd = '';

  // 1. å­¸ç”ŸæŸ¥è©¢ (å«å¯†ç¢¼)
  async function studentQuery() {
    const id = document.getElementById('stuId').value;
    const pwd = document.getElementById('stuPwd').value;
    const res = await fetch(`${GAS_URL}?action=studentQuery&id=${id}&pwd=${pwd}`);
    const data = await res.json();
    const div = document.getElementById('queryStatus');
    div.innerHTML = data.success ? `<div class="alert alert-success mt-2"><b>${data.name}</b> åŒå­¸ï¼šç›®å‰ç¸½é»æ•¸ <b>${data.points}</b></div>` : `<div class="alert alert-danger mt-2">${data.msg}</div>`;
  }

  // 2. ç®¡ç†å“¡ç™»å…¥ä¸¦ç²å–è³‡æ–™
  async function adminLogin() {
    const pwd = document.getElementById('adminPwd').value;
    const res = await fetch(`${GAS_URL}?action=getAdminData&adminPwd=${pwd}`);
    const data = await res.json();
    if(data.success) {
      currentAdminPwd = pwd;
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      renderTable(data.data);
    } else { alert(data.msg); }
  }

  function renderTable(list) {
    document.getElementById('stuListBody').innerHTML = list.map(s => `
      <tr>
        <td><b>${s.name}</b> <small class="text-muted">${s.id}</small></td>
        <td class="text-center fw-bold">${s.total}</td>
        <td class="text-end"><input type="number" class="point-input" id="in-${s.id}" data-id="${s.id}" placeholder="+/-"></td>
      </tr>
    `).join('');
  }

  // 3. æ‰¹æ¬¡æ›´æ–° (ç•™åœ¨åŸç•«é¢)
  async function submitBatch() {
    const inputs = document.querySelectorAll('.point-input');
    const updates = [];
    inputs.forEach(i => { if(i.value && i.value != 0) updates.push({id: i.dataset.id, val: i.value}); });
    if(updates.length === 0) return alert('æœªè¼¸å…¥è³‡æ–™');

    document.getElementById('updateBtn').innerText = 'æ›´æ–°ä¸­...';
    const res = await fetch(`${GAS_URL}?action=batchUpdate&adminPwd=${currentAdminPwd}&updates=${encodeURIComponent(JSON.stringify(updates))}`);
    const data = await res.json();
    alert(data.msg);
    if(data.success) adminLogin(); // é‡æ–°æ•´ç†è³‡æ–™ä½†ä¸è·³é 
    document.getElementById('updateBtn').innerText = 'âœ… çµ±ä¸€æ›´æ–°å…¨ç­é»æ•¸';
  }

  // 4. å¤§é‡åŒ¯å…¥
  async function importData() {
    const csv = document.getElementById('csvData').value;
    if(!confirm('é€™å°‡è¦†è“‹ç¾æœ‰åå–®ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
    const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ adminPwd: currentAdminPwd, csv: csv }) });
    const data = await res.json();
    alert(data.msg);
    if(data.success) adminLogin();
  }

  // 5. ä¿®æ”¹ç®¡ç†å¯†ç¢¼
  async function changeAdminPwd() {
    const np = document.getElementById('newAdminPwd').value;
    const res = await fetch(`${GAS_URL}?action=updateAdminPwd&adminPwd=${currentAdminPwd}&newPwd=${np}`);
    const data = await res.json();
    alert(data.msg);
    if(data.success) currentAdminPwd = np;
  }

  function switchTab(tab) {
    ['edit', 'import', 'setting'].forEach(t => {
      document.getElementById('tab-' + t).style.display = (t === tab ? 'block' : 'none');
    });
    document.querySelectorAll('#adminTabs .nav-link').forEach(l => l.classList.remove('active'));
    event.target.classList.add('active');
  }
</script>
</body>
</html>
