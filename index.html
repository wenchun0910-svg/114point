<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç”Ÿé»æ•¸ç®¡ç†ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .student-row { transition: background-color 0.3s; }
    .student-row:hover { background-color: #f8f9fa; }
    /* èª¿æ•´è¼¸å…¥æ¡†æ¨£å¼ä»¥ç¬¦åˆåœ–ç‰‡ */
    .point-input-group { max-width: 150px; }
  </style>
</head>
<body class="bg-light">
<div class="container py-4" style="max-width: 800px;">
  <h2 class="text-center mb-4 fw-bold">ğŸ“ å­¸ç”Ÿè¡¨ç¾ç©é»ç³»çµ±</h2>

  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      ğŸ” å­¸ç”Ÿé»æ•¸æŸ¥è©¢
    </div>
    <div class="card-body">
      <div class="input-group mb-3">
        <input type="text" id="stuId" class="form-control" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ (ä¾‹å¦‚: 101)""
        <button class="btn btn-primary" onclick="queryPoint()">æŸ¥è©¢</button>
      </div>
      <div id="queryResult"></div>
    </div>
  </div>

  <div id="loginArea" class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
      ğŸ” ç®¡ç†å“¡ç™»å…¥
    </div>
    <div class="card-body">
      <div class="input-group">
        <input type="password" id="adminPwd" class="form-control" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
        <button class="btn btn-dark" onclick="adminLogin()">ç™»å…¥å¾Œå°</button>
      </div>
    </div>
  </div>

  <div id="adminPanel" style="display:none;">
    
    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-outline-primary active" id="btnShowList" onclick="switchAdminView('list')">ğŸ“‹ å€‹åˆ¥é»æ•¸ç®¡ç†</button>
      <button class="btn btn-outline-secondary" id="btnShowTools" onclick="switchAdminView('tools')">ğŸ› ï¸ å…¶ä»–ç®¡ç†å·¥å…·</button>
    </div>

    <div id="adminListView">
      <div class="card shadow-sm">
        <div class="card-header bg-white fw-bold fs-5">
          æ¯é€±é»æ•¸ç´€éŒ„
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col" class="ps-4">å§“å</th>
                  <th scope="col" class="text-center">ç›®å‰ç¸½é»æ•¸</th>
                  <th scope="col" class="text-end pe-4">æœ¬é€±åŠ /æ¸›é»æ•¸</th>
                </tr>
              </thead>
              <tbody id="studentTableBody">
                <tr><td colspan="3" class="text-center py-3">è¼‰å…¥ä¸­...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="adminToolsView" style="display:none;">
      <div class="row g-3">
        <div class="col-md-12">
          <div class="card border-danger h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center">
              <h5 class="card-title text-danger">âš¡ æ¯é€±é»æ•¸çµç®—</h5>
              <p class="card-text text-muted small mb-3">å°‡æ‰€æœ‰å­¸ç”Ÿçš„ã€Œæœ¬é€±é»æ•¸ã€ç´¯åŠ åˆ°ã€Œç¸½é»æ•¸ã€ï¼Œä¸¦æ¸…ç©ºæœ¬é€±ç´€éŒ„ã€‚</p>
              <button class="btn btn-danger w-100" onclick="doAdminAction('batchUpdate')">åŸ·è¡Œæœ¬é€±çµç®—</button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">ğŸ“¥ å¤§é‡åŒ¯å…¥åå–® (CSV)</h6>
              <textarea id="csvInput" class="form-control mb-2" rows="4" placeholder="æ ¼å¼: å­¸è™Ÿ,å§“å,ç¸½åˆ†,æœ¬é€±åˆ†&#10;ä¾‹å¦‚: 101,ç‹å°æ˜,50,0"></textarea>
              <button class="btn btn-success w-100" onclick="importCSV()">åŒ¯å…¥è³‡æ–™</button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">ğŸ”‘ ä¿®æ”¹ç®¡ç†å¯†ç¢¼</h6>
              <input type="text" id="newPwd" class="form-control mb-2" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
              <button class="btn btn-outline-secondary w-100" onclick="doAdminAction('changePwd')">ç¢ºèªä¿®æ”¹</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div> <div id="loadingToast" class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          è™•ç†ä¸­ï¼Œè«‹ç¨å€™...
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ğŸ”¥ è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨éƒ¨ç½²å¾Œçš„ Google Apps Script ç¶²å€
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbynfpyuMx8yyPtAjV6i92yDiTxzC0p085breutDHLmJzfWnvYMLVyt7iPn-R5i_g8Mk/exec';

  let currentAdminPwd = '';
  const loadingToast = new bootstrap.Toast(document.getElementById('liveToast'));

  // --- é¡¯ç¤º/éš±è— Loading ---
  function showLoading(show) {
    show ? loadingToast.show() : loadingToast.hide();
  }

  // ================= å­¸ç”ŸåŠŸèƒ½ =================
  async function queryPoint() {
    const id = document.getElementById('stuId').value.trim();
    if (!id) return alert('è«‹è¼¸å…¥å¸³è™Ÿ');
    
    showLoading(true);
    try {
      const res = await fetch(`${GAS_URL}?action=query&id=${id}`);
      const data = await res.json();
      const resultDiv = document.getElementById('queryResult');
      if (data.success) {
        resultDiv.innerHTML = `<div class="alert alert-success mt-3 mb-0 fw-bold">${data.data.name} åŒå­¸ï¼Œä½ çš„ç›®å‰ç¸½é»æ•¸ç‚ºï¼š<span class="fs-4">${data.data.points}</span> é»</div>`;
      } else {
        resultDiv.innerHTML = `<div class="alert alert-danger mt-3 mb-0">${data.msg}</div>`;
      }
    } catch (err) {
      alert('æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚');
    } finally {
      showLoading(false);
    }
  }

  // ================= ç®¡ç†å“¡åŠŸèƒ½ =================
  
  // 1. ç®¡ç†å“¡ç™»å…¥
  async function adminLogin() {
    const pwd = document.getElementById('adminPwd').value;
    if (!pwd) return alert('è«‹è¼¸å…¥å¯†ç¢¼');

    showLoading(true);
    // å˜—è©¦æŠ“å–å­¸ç”Ÿåˆ—è¡¨ä¾†é©—è­‰å¯†ç¢¼
    const url = `${GAS_URL}?action=getAllStudents&pwd=${pwd}`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      
      if (data.success) {
        currentAdminPwd = pwd; // æš«å­˜å¯†ç¢¼ä¾›å¾ŒçºŒæ“ä½œä½¿ç”¨
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        renderStudentTable(data.data); // ç™»å…¥æˆåŠŸå¾Œï¼Œæ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨
      } else {
        alert(data.msg);
      }
    } catch (err) {
      alert('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
    } finally {
      showLoading(false);
    }
  }

  // 2. æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨ (ä»¿ç…§åœ–ç‰‡æ¨£å¼)
  function renderStudentTable(students) {
    const tbody = document.getElementById('studentTableBody');
    tbody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹
    
    if (students.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center py-3">ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™</td></tr>';
      return;
    }

    students.forEach(stu => {
      const tr = document.createElement('tr');
      tr.className = 'student-row';
      tr.innerHTML = `
        <td class="ps-4 fw-bold">
          <span class="text-primary">${stu.id}</span> ${stu.name}
        </td>
        <td class="text-center fs-5 fw-bold">${stu.total}</td>
        <td class="text-end pe-4 py-2">
          <div class="input-group point-input-group ms-auto">
            <input type="number" class="form-control text-center" placeholder="+/-" id="input-${stu.id}">
            <button class="btn btn-outline-primary" type="button" onclick="updatePoint('${stu.id}', '${stu.name}')">ç¢ºèª</button>
          </div>
          <div class="text-muted small mt-1">æœ¬é€±å·²ç™»è¨˜: <span id="weekly-${stu.id}">${stu.weekly}</span></div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 3. [æ–°åŠŸèƒ½] æ›´æ–°å–®ä¸€å­¸ç”Ÿé»æ•¸
  async function updatePoint(stuId, stuName) {
    const inputField = document.getElementById(`input-${stuId}`);
    const points = inputField.value;
    if (!points || points == 0) return alert('è«‹è¼¸å…¥è¦å¢åŠ æˆ–æ¸›å°‘çš„é»æ•¸ (ä¸èƒ½ç‚º 0)');

    showLoading(true);
    const url = `${GAS_URL}?action=updateIndividual&id=${stuId}&points=${points}&pwd=${currentAdminPwd}`;
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.success) {
        // æ›´æ–°æˆåŠŸå¾Œï¼Œåªéœ€æ›´æ–°è©²å­¸ç”Ÿçš„ã€Œæœ¬é€±å·²ç™»è¨˜ã€æ•¸å€¼ï¼Œä¸ç”¨é‡æ•´æ•´å€‹è¡¨æ ¼
        document.getElementById(`weekly-${stuId}`).innerText = data.newWeekly;
        inputField.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
        // é¡¯ç¤ºä¸€å€‹å°çš„æˆåŠŸæç¤º
        const toast = new bootstrap.Toast(document.getElementById('liveToast'));
        document.querySelector('.toast-body').innerText = `å·²æ›´æ–° ${stuName} çš„é»æ•¸ï¼`;
        toast.show();
        setTimeout(() => toast.hide(), 2000);
      } else {
        alert(data.msg);
      }
    } catch (err) {
      alert('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    } finally {
      showLoading(false);
    }
  }

  // 4. åˆ‡æ›ç®¡ç†ä»‹é¢è¦–åœ– (åˆ—è¡¨/å·¥å…·)
  function switchAdminView(view) {
    const listView = document.getElementById('adminListView');
    const toolsView = document.getElementById('adminToolsView');
    const btnList = document.getElementById('btnShowList');
    const btnTools = document.getElementById('btnShowTools');

    if (view === 'list') {
      listView.style.display = 'block';
      toolsView.style.display = 'none';
      btnList.classList.add('active', 'btn-outline-primary');
      btnList.classList.remove('btn-outline-secondary');
      btnTools.classList.add('btn-outline-secondary');
      btnTools.classList.remove('active', 'btn-outline-primary');
      // åˆ‡æ›å›åˆ—è¡¨æ™‚ï¼Œé‡æ–°æŠ“å–è³‡æ–™ä»¥ç¢ºä¿åŒæ­¥
      if (currentAdminPwd) reloadStudentTable();
    } else {
      listView.style.display = 'none';
      toolsView.style.display = 'block';
      btnTools.classList.add('active', 'btn-outline-primary');
      btnTools.classList.remove('btn-outline-secondary');
      btnList.classList.add('btn-outline-secondary');
      btnList.classList.remove('active', 'btn-outline-primary');
    }
  }

  // é‡æ–°è¼‰å…¥è¡¨æ ¼è³‡æ–™çš„è¼”åŠ©å‡½å¼
  async function reloadStudentTable() {
    showLoading(true);
    try {
      const res = await fetch(`${GAS_URL}?action=getAllStudents&pwd=${currentAdminPwd}`);
      const data = await res.json();
      if (data.success) renderStudentTable(data.data);
    } catch(e) { console.error(e); } finally { showLoading(false); }
  }

  // 5. åŸ·è¡Œå…¶ä»–ç®¡ç†å‹•ä½œ (çµç®—ã€æ”¹å¯†ç¢¼)
  async function doAdminAction(action) {
    let url = `${GAS_URL}?action=${action}&pwd=${currentAdminPwd}`;
    if (action === 'batchUpdate') {
      if (!confirm('ç¢ºå®šè¦çµç®—æœ¬é€±é»æ•¸å—ï¼Ÿ\né€™å°‡æœƒæŠŠã€Œæœ¬é€±åŠ /æ¸›ã€ç´¯åŠ åˆ°ã€Œç¸½é»æ•¸ã€ä¸¦æ¸…ç©ºæœ¬é€±ç´€éŒ„ã€‚')) return;
    } else if (action === 'changePwd') {
      const newPwd = document.getElementById('newPwd').value;
      if (!newPwd) return alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼');
      url += `&newPwd=${newPwd}`;
    }

    showLoading(true);
    try {
      const res = await fetch(url);
      const data = await res.json();
      alert(data.msg);
      if (data.success && action === 'batchUpdate') {
        // çµç®—æˆåŠŸå¾Œï¼Œé‡æ–°è¼‰å…¥è¡¨æ ¼ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„ç¸½åˆ†å’Œæ¸…ç©ºçš„æœ¬é€±åˆ†æ•¸
        switchAdminView('list');
      }
      if (data.success && action === 'changePwd') document.getElementById('newPwd').value = '';
    } catch (err) {
      alert('åŸ·è¡Œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
    } finally {
      showLoading(false);
    }
  }

  // 6. å¤§é‡åŒ¯å…¥ (POST è«‹æ±‚)
  async function importCSV() {
    const csv = document.getElementById('csvInput').value;
    if (!csv) return alert('è«‹è¼¸å…¥è¦åŒ¯å…¥çš„è³‡æ–™');
    if (!confirm('è­¦å‘Šï¼šé€™å°‡æœƒã€Œå®Œå…¨è¦†è“‹ã€ç›®å‰çš„å­¸ç”Ÿåå–®å’Œé»æ•¸ç´€éŒ„ï¼ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) return;

    showLoading(true);
    try {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'import', pwd: currentAdminPwd, csv: csv })
      });
      const data = await res.json();
      alert(data.msg);
      if (data.success) {
        document.getElementById('csvInput').value = '';
        reloadStudentTable(); // åŒ¯å…¥æˆåŠŸå¾Œåˆ·æ–°åˆ—è¡¨
      }
    } catch (err) {
      alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™æ ¼å¼æˆ–ç¶²è·¯ã€‚');
    } finally {
      showLoading(false);
    }
  }
</script>
</body>
</html>
